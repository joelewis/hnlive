<!DOCTYPE html>
<html> 
<head>
  <title>Hacker News Activity Stats</title>
  <link href="/static/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <div class="container">
        
        <div style="height: 400px;" id="realtime"></div>
        
        <div class="panel panel-default" style="height: 600px;margin-top: 100px;display:none;">
          <div class="panel-heading">
            <h3 class="panel-title"> Last Week Activity </h3>
          </div>
          <div class="panel-body">
            <div id="lastweek"> </div>
          </div>
      </div>
    </div>

  <script src="/static/js/underscore.js"></script>
  <script src="/static/js/jquery.js"></script>
  <script src="/static/js/canvasjs.min.js"></script>
  <script src="/static/js/bootstrap.min.js"></script>
  
  <script>
    var dps = [], realtimeChart, lastWeekChart;
    var lastWeekActivity = [];
    var lastWeek = [];
    var averageWeekDay = [];
    var yesterday = [];
    var averageTimeSlot = [];
    
    var updateChart = function() {
        $.get('/variance').then(function(resp) {
            var datapoints = resp.datapoints;
            var datapoints = datapoints.map(function(dp) {
                return {
                    x: new Date(dp.time).getTime(),
                    y: dp.variance
                };
            })
            dps.splice(0, dps.length);
            _.each(datapoints, function(dp) {
                dps.push(dp);
            });
            realtimeChart.render();
        });
    };
    
    var updateLastWeekChart = function() {
        $.get('/lastweek').then(function(resp) {
            var datapoints = _.map(resp.lastWeekActivity, function(dp, key) {
                return {
                    legendText: key,
                    indexLabel: key,
                    y: dp.average
                };
            })
            
            // empty contents of lastWeekActivity;
            lastWeekActivity.splice(0, lastWeekActivity.length); 
            
            _.each(datapoints, function(dp) {
                lastWeekActivity.push(dp);
            });
            
            lastWeekChart.render();
        });
    };
    
    $(function() { // dom init
        
        realtimeChart = new CanvasJS.Chart("realtime", {
            theme: 'theme1',
            type: 'doughnut',
            title :{
                text: "Hacker News Activity"
            },		
            axisX:{  
                title: 'time',
                valueFormatString: "hh TT DDDD MMM",
                gridThickness: 1,
            },
            
            axisY: {
                gridThickness: 1,
                title: 'activity',
            },
            
            data: [{
                type: "area",
                dataPoints: dps,
                xValueType: 'dateTime',
                showInLegend: true,
                name: 'Activity on adding new comments & top story upvotes'
            }],
            legend:{
                cursor:"pointer",
            }
        });
        
        lastWeekChart = new CanvasJS.Chart("lastweek", {
            title :{
                text: "Last Week Summary"
            },		
            axisX:{  
                title: 'Day of Week',
                gridThickness: 1,
            },
            
            axisY: {
                gridThickness: 1,
                title: 'activity',
            },
            
            data: [{
                type: "doughnut",
                dataPoints: lastWeekActivity,
                showInLegend: true,
            }],
            legend:{
                cursor:"pointer",
            }
        });
        
        realtimeChart.render();
        // update every 5 seconds.
        updateChart();
        updateLastWeekChart();
        setInterval(updateChart, 30000);
    });
  </script>
</body>
</html>
